{% extends "web.html" %}
{% block title %}Toads Profile{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payment_card.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row g-4">
        <!-- –ë–ª–æ–∫ 1 -->
        <div class="col-md-4">
            <div class="p-3 rounded-3 greenInfoCard">
                <h5 class="text-center mb-3">–ü—Ä–æ—Ñ–∏–ª—å</h5>
                <ul class="list-unstyled">
                    <li>ID: {{ user.id }}</li>
                    <li>
                        VIP: 
                        <button 
                            class="btn btn-sm {% if user.is_vip %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_vip">
                            {% if user.is_vip %}–í–∫–ª—é—á–µ–Ω–æ{% else %}–í—ã–∫–ª—é—á–µ–Ω–æ{% endif %}
                        </button>
                    </li>
                    <li>
                        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä: 
                        <button 
                            class="btn btn-sm {% if user.is_calculate %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_calculate"
                            data-user-id="{{ user.id }}">
                            {% if user.is_calculate %}–í–∫–ª—é—á–µ–Ω{% else %}–í—ã–∫–ª—é—á–µ–Ω{% endif %}
                        </button>
                    </li>
                    <li>–û–ø–ª–∞—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }}</li>
                    <div class="p-3 rounded-3 greenInfoCard">
                        <h5 class="text-center mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —á–∞—Ç–∞</h5>
                        <ul class="list-unstyled mb-0">
                            <li>
                                <strong>Chat ID:</strong>
                                {{ user.chat_id if user.chat_id else "–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω" }}
                            </li>
                            <li class="mt-1">
                                <strong>Chat Title:</strong>
                                {{ user.chat_title if user.chat_title else "–ù–µ –∑–∞–¥–∞–Ω–æ" }}
                            </li>
                        </ul>
                    </div>

                    <div class="col-md-4">
                        <div class="p-3 rounded-3 payment-card">

                            <div class="frog-icon">üê∏</div>
                            <div class="tree-icon">üå≥</div>

                            <h5 class="payment-card-title">
                                –û–ø–ª–∞—Ç–∞
                            </h5>

                            <div class="payment-card-date">
                                <div class="label">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ</div>
                                <div class="value">
                                    {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }}
                                </div>
                            </div>

                        </div>
                    </div>


                </ul>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 2 -->
        <div class="col-md-8">
            <div class="p-3 rounded-3 greenInfoCard">
                <h5 class="text-center mb-3">–§—É–Ω–∫—Ü–∏–∏</h5>

                {% for task in tasks.tasks %}
                <div class="task-row mb-3 p-2 rounded border" style="background-color: #f8f9fa;">
                    <div class="row align-items-start">

                        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ work-type -->
                        <div class="col-6">
                            <span class="fw-semibold">{{ task.task_type.title }}</span>

                            {% if task.task_type.value == "work" %}
                            <div class="mt-1">
                                <select
                                    class="form-select form-select-sm work-type-select"
                                    data-task-type="work"
                                    style="min-width: 140px;"
                                >
                                    {% for key, title in MAPPER_WORK_TOAD.items() %}
                                        <option value="{{ key }}" {% if task.extra["type"] == key %}selected{% endif %}>
                                            {{ title }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <div class="text-muted small mt-1 next-run-text">
                                ‚è± –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: {{ task.next_run.strftime("%d.%m.%Y, %H:%M") }}
                            </div>
                        </div>

                        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –∏ input -->
                        <div class="col-6 d-flex flex-column">
                            <button 
                                class="btn btn-sm toggle-task-btn btn-turn mb-2 {% if task.turn %}btn-turn-on{% else %}btn-turn-off{% endif %}"
                                data-task-type="{{ task.task_type.value }}"
                                title="{% if task.turn %}–í–∫–ª—é—á–µ–Ω–æ{% else %}–í—ã–∫–ª—é—á–µ–Ω–æ{% endif %}">
                                {% if task.turn %}
                                    <i class="bi bi-check-lg"></i>
                                {% else %}
                                    <i class="bi bi-x-lg"></i>
                                {% endif %}
                            </button>

                            <!-- Input datetime + –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å -->
                            <div class="d-flex w-100">
                                <input 
                                    type="datetime-local" 
                                    class="form-control form-control-sm me-1"
                                    data-task-type="{{ task.task_type.value }}"
                                    value="{{ task.next_run.strftime('%Y-%m-%dT%H:%M:%S') }}"
                                    style="flex: 1;"
                                >
                                <button 
                                    class="btn btn-sm btn-primary apply-next-run-btn"
                                    data-task-type="{{ task.task_type.value }}"
                                    title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è"
                                >
                                    ‚úî
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>
        </div>


    </div>
</div>

<script>
document.querySelectorAll(".toggle-user-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const field = button.dataset.field;
        const newState = !button.classList.contains("btn-success"); // –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º

        try {
            const response = await fetch("/ajax/set/turn", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    field: field,
                    value: newState
                })
            });

            if (response.ok) {
                // –º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –∏ —Ç–µ–∫—Å—Ç
                button.classList.toggle("btn-success", newState);
                button.classList.toggle("btn-secondary", !newState);
                button.textContent = newState ? "–í–∫–ª—é—á–µ–Ω–æ" : "–í—ã–∫–ª—é—á–µ–Ω–æ";
            } else {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—è");
            }
        } catch (err) {
            console.error(err);
        }
    });
});
</script>


<script>
document.querySelectorAll('.toggle-task-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const taskType = button.dataset.taskType;
        const newState = !button.classList.contains('btn-turn-on'); // –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ

        try {
            const response = await fetch("/ajax/set/turn", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    field: taskType,
                    value: newState
                })
            });

            if (response.ok) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –∫–Ω–æ–ø–∫—É
                button.classList.toggle("btn-turn-on", newState);
                button.classList.toggle("btn-turn-off", !newState);

                const icon = button.querySelector("i");
                if (newState) {
                    icon.classList.remove("bi-x-lg");
                    icon.classList.add("bi-check-lg");
                } else {
                    icon.classList.remove("bi-check-lg");
                    icon.classList.add("bi-x-lg");
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º tooltip
                button.title = newState ? "–í–∫–ª—é—á–µ–Ω–æ" : "–í—ã–∫–ª—é—á–µ–Ω–æ";
            } else {
                const data = await response.json();
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", data.message || response.statusText);
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ AJAX:", err);
        }
    });
});
</script>

<script>
document.querySelectorAll(".work-type-select").forEach(select => {
    select.addEventListener("change", async () => {
        const workType = select.value;

        try {
            const response = await fetch("/ajax/set/work", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    type: workType
                })
            });

            if (!response.ok) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç—ã");
            }
        } catch (e) {
            console.error("AJAX error:", e);
        }
    });
});
</script>

<script>
document.querySelectorAll('.apply-next-run-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const taskType = button.dataset.taskType;
        const input = button.previousElementSibling; // input datetime-local
        const newDatetime = input.value; // —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DDTHH:MM:SS

        try {
            const response = await fetch('/ajax/set/next_run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: taskType,
                    next_run: newDatetime
                })
            });

            if (response.ok) {
                const result = await response.json();

                // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ "–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫" –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏
                const taskRow = button.closest('.task-row');
                const nextRunDiv = taskRow.querySelector('.next-run-text');

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç HH:MM DD.MM.YYYY
                const dt = new Date(newDatetime);
                const formatted = dt.toLocaleString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                nextRunDiv.textContent = `‚è± –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: ${formatted}`;
            } else {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã');
            }
        } catch (err) {
            console.error(err);
        }
    });
});
</script>

{% endblock %}