{% extends "web.html" %}
{% block title %}Toads Profile{% endblock %}

{% block html_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payment_card.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat_card.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/telegram_card.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row g-4">
        <!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="col-md-4">
            <div class="p-3 rounded-3 greenInfoCard">

                <h5 class="text-center mb-3">–ü—Ä–æ—Ñ–∏–ª—å</h5>

                <ul class="list-unstyled mb-3">
                    <li>ID: {{ user.id }}</li>

                    <li class="mt-2">
                        VIP:
                        <button 
                            class="btn btn-sm {% if user.is_vip %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_vip">
                            {% if user.is_vip %}–í–∫–ª—é—á–µ–Ω–æ{% else %}–í—ã–∫–ª—é—á–µ–Ω–æ{% endif %}
                        </button>
                    </li>

                    <li class="mt-2">
                        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:
                        <button 
                            class="btn btn-sm {% if user.is_calculate %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_calculate">
                            {% if user.is_calculate %}–í–∫–ª—é—á–µ–Ω{% else %}–í—ã–∫–ª—é—á–µ–Ω{% endif %}
                        </button>
                    </li>
                </ul>

                <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä—è–¥: 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –≥–ª–∞–≤–Ω–æ–π -->
                <div class="row mb-3">
                    
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —á–∞—Ç–∞ -->
                    <div class="col-6">
                        <div class="p-3 rounded-3 info-blue-card">

                            <div class="leaf-icon">üçÉ</div>
                            <div class="fly-icon">ü™∞</div>

                            <h5 class="info-card-title text-center mb-3">
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —á–∞—Ç–∞
                            </h5>

                            <ul class="list-unstyled mb-0 text-center">
                                <li class="mb-2">
                                    <strong>Chat ID:</strong><br>
                                    {{ user.chat_id if user.chat_id else "–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω" }}
                                </li>

                                <li>
                                    <strong>Chat Title:</strong><br>
                                    {{ user.chat_title if user.chat_title else "–ù–µ –∑–∞–¥–∞–Ω–æ" }}
                                </li>
                            </ul>

                        </div>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –û–ø–ª–∞—Ç–∞ -->
                    <div class="col-6">
                        <div class="p-3 rounded-3 payment-card">

                            <div class="frog-icon">üê∏</div>
                            <div class="tree-icon">üå≥</div>

                            <h5 class="payment-card-title text-center mb-3">
                                –û–ø–ª–∞—Ç–∞
                            </h5>

                            <div class="payment-card-date text-center">
                                <div class="label">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ</div>
                                
                                {% set time_diff = (user.paid_until - FUNC_CURRENT_TIME_UTC()).total_seconds() if user.paid_until else -1 %}
                                {% if time_diff < 0 %}
                                    <div class="value" style="color: #5900ff;">
                                        {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }} (–ò—Å—Ç–µ–∫–ª–∞)
                                    </div>
                                {% elif time_diff < 93600 %} {# 93600 —Å–µ–∫ = 26 —á–∞—Å–æ–≤ (1 –¥–µ–Ω—å + 2 —á–∞—Å–∞) #}
                                    <div class="value" style="color: red;">
                                        {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }}
                                    </div>
                                {% else %}
                                    <div class="value" style="color: green;">
                                        {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }}
                                    </div>
                                {% endif %}

                            </div>

                        </div>
                    </div>

                </div>
                <!-- /–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä—è–¥ -->
                
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ Telegram -->
            <div class="col-12">
                <div class="p-3 rounded-3 telegram-info-card">

                    <div class="pc-icon">üíª</div>
                    <div class="disk-icon">üíø</div>

                    <h5 class="telegram-card-title text-center mb-3">
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è Telegram
                    </h5>

                    <ul class="list-unstyled mb-0 text-center telegram-info-list">
                        <li class="mb-2">
                            <strong>API ID:</strong><br>
                            <span id="tg-api-id">
                                {{ user.api_id if user.api_id else "–ù–µ –∑–∞–¥–∞–Ω–æ" }}
                            </span>
                        </li>

                        <li class="mb-2">
                            <strong>API Hash:</strong><br>
                            <span id="tg-api-hash">
                                {{ user.api_hash if user.api_hash else "–ù–µ –∑–∞–¥–∞–Ω–æ" }}
                            </span>
                        </li>

                        <li class="mb-2">
                            <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong><br>
                            <span id="tg-phone">
                                {{ user.phone if user.phone else "–ù–µ –∑–∞–¥–∞–Ω" }}
                            </span>
                        </li>

                        <li>
                            <strong>2FA –ø–∞—Ä–æ–ª—å:</strong><br>
                            <span id="tg-2fa">
                                {{user.password_2fa if user.password_2fa else "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" }}
                            </span>
                        </li>

                    </ul>

                </div>
            </div>

            </div>
        </div>

        <!-- –ë–ª–æ–∫ 2 -->
        <div class="col-md-4">
            <div class="p-3 rounded-3 greenInfoCard">
                <h5 class="text-center mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h5>

                {% for task in tasks.tasks %}
                <div class="task-row mb-3 p-2 rounded border" style="background-color: #f8f9fa;">

                    <!-- –ö–Ω–æ–ø–∫–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
                    <div class="d-flex align-items-center mb-2">
                        <button 
                            class="btn btn-sm toggle-task-btn btn-turn me-2 {% if task.turn %}btn-turn-on{% else %}btn-turn-off{% endif %}"
                            data-task-type="{{ task.task_type.value }}"
                            title="{% if task.turn %}–í–∫–ª—é—á–µ–Ω–æ{% else %}–í—ã–∫–ª—é—á–µ–Ω–æ{% endif %}">
                            {% if task.turn %}
                                <i class="bi bi-check-lg"></i>
                            {% else %}
                                <i class="bi bi-x-lg"></i>
                            {% endif %}
                        </button>
                        <div class="fw-semibold">{{ task.task_type.title }}</div>
                    </div>

                    <!-- –¢–∏–ø —Ä–∞–±–æ—Ç—ã –¥–ª—è work -->
                    {% if task.task_type.value == "work" %}
                    <div class="mb-2">
                        <select
                            class="form-select form-select-sm work-type-select"
                            data-task-type="work"
                        >
                            {% for key, title in MAPPER_WORK_TOAD.items() %}
                                <option value="{{ key }}" {% if task.extra["type"] == key %}selected{% endif %}>
                                    {{ title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ -->
                    <div class="text-muted small mb-2">
                        ‚è± –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: {{ task.next_run.strftime("%d.%m.%Y, %H:%M") }}
                    </div>

                    <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ -->
                    <div class="d-flex mb-1">
                        <input 
                            type="datetime-local" 
                            class="form-control form-control-sm me-1 next-run-input"
                            data-task-type="{{ task.task_type.value }}"
                            value="{{ task.next_run.strftime('%Y-%m-%dT%H:%M:%S') }}"
                            style="flex: 1;"
                        >
                        <button 
                            class="btn btn-sm btn-primary apply-next-run-btn"
                            data-task-type="{{ task.task_type.value }}"
                            title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è"
                        >
                            ‚úî
                        </button>
                    </div>
                    <div class="text-muted small mt-1 preview-next-run" data-task-type="{{ task.task_type.value }}">
                        ‚è± –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: {{ task.next_run.strftime('%d.%m.%y, %H:%M:%S') }}
                    </div>

                </div>
                {% endfor %}

            </div>
        </div>

        <!-- –ë–ª–æ–∫ 3 -->
        <div class="col-md-4">
            <div class="telegram-card p-3 rounded-3">

                <h5 class="text-center mb-3 telegram-card-title">Telegram</h5>

                <div class="mb-2">
                    <label class="form-label small telegram-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input 
                        type="text"
                        class="form-control form-control-sm telegram-input-field telegram-input"
                        data-field="phone"
                        placeholder="89991234567"
                    >
                </div>

                <div class="mb-2">
                    <label class="form-label small telegram-label">2FA –ø–∞—Ä–æ–ª—å</label>
                    <input 
                        type="text"
                        class="form-control form-control-sm telegram-input-field telegram-input"
                        data-field="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    >
                </div>

                <div class="mb-2">
                    <label class="form-label small telegram-label">API ID</label>
                    <input 
                        type="text"
                        class="form-control form-control-sm telegram-input-field telegram-input"
                        data-field="api_id"
                        placeholder="123456"
                    >
                </div>

                <div class="mb-3">
                    <label class="form-label small telegram-label">API Hash</label>
                    <input 
                        type="text"
                        class="form-control form-control-sm telegram-input-field telegram-input"
                        data-field="api_hash"
                        placeholder="abcdef123456"
                    >
                </div>

                <button 
                    class="btn telegram-apply-btn w-100 btn-sm"
                    id="applyTelegramBtn"
                    title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram"
                >
                    ‚úàÔ∏è –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>

            </div>
        </div>


    </div>
</div>
{% endblock %}


{% block scripts_js %}
    <script src="{{ url_for('static', filename='js/datetime_preview_updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datetime_task_updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/switch_task_turn_updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/switch_user_turn_updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/telegram_data_update.js') }}"></script>
    <script src="{{ url_for('static', filename='js/work_type_updater.js') }}"></script>
{% endblock %}