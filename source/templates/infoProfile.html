{% extends "web.html" %}
{% block title %}Toads Profile{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row g-4">
        <!-- Блок 1 -->
        <div class="col-md-4">
            <div class="p-3 rounded-3 greenInfoCard">
                <h5 class="text-center mb-3">Профиль</h5>
                <ul class="list-unstyled">
                    <li>ID: {{ user.id }}</li>
                    <li>
                        VIP: 
                        <button 
                            class="btn btn-sm {% if user.is_vip %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_vip">
                            {% if user.is_vip %}Включено{% else %}Выключено{% endif %}
                        </button>
                    </li>
                    <li>
                        Калькулятор: 
                        <button 
                            class="btn btn-sm {% if user.is_calculate %}btn-success{% else %}btn-secondary{% endif %} toggle-user-btn"
                            data-field="is_calculate"
                            data-user-id="{{ user.id }}">
                            {% if user.is_calculate %}Включен{% else %}Выключен{% endif %}
                        </button>
                    </li>
                    <li>Оплата активна до: {{ user.paid_until.strftime("%H:%M:%S %d.%m.%Y") }}</li>
                </ul>
            </div>
        </div>

        <!-- Блок 2 -->
        <div class="col-md-4">
            <div class="p-3 rounded-3 greenInfoCard">
                <h5 class="text-center mb-3">Функции</h5>

                {% for task in tasks.tasks %}
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded task-row">

                    <div>
                        <span class="fw-semibold">{{ task.task_type.title }}</span>

                        {% if task.task_type.value == "work" %}
                        <div class="mt-1 p-1 rounded bg-light border small">
                            <strong>Тип:</strong>
                            {{ MAPPER_WORK_TOAD.get(task.extra["type"], "Беззаботный") }}
                        </div>
                        {% endif %}
                    </div>

                    <button 
                        class="btn btn-sm toggle-task-btn btn-turn {% if task.turn %}btn-turn-on{% else %}btn-turn-off{% endif %}"
                        data-task-type="{{ task.task_type.value }}"
                        title="{% if task.turn %}Включено{% else %}Выключено{% endif %}">
                        {% if task.turn %}
                            <i class="bi bi-check-lg"></i>
                        {% else %}
                            <i class="bi bi-x-lg"></i>
                        {% endif %}
                    </button>

                </div>

                <div class="text-muted small mb-3 ms-2">
                    ⏱ Следующий запуск:
                    {{ task.next_run.strftime("%H:%M:%S %d.%m.%Y") }}
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
document.querySelectorAll(".toggle-user-btn").forEach(button => {
    button.addEventListener("click", async () => {
        const field = button.dataset.field;
        const newState = !button.classList.contains("btn-success"); // инвертируем

        try {
            const response = await fetch("/ajax/set/turn", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    field: field,
                    value: newState
                })
            });

            if (response.ok) {
                // меняем стиль кнопки и текст
                button.classList.toggle("btn-success", newState);
                button.classList.toggle("btn-secondary", !newState);
                button.textContent = newState ? "Включено" : "Выключено";
            } else {
                console.error("Ошибка обновления поля");
            }
        } catch (err) {
            console.error(err);
        }
    });
});
</script>


<script>
document.querySelectorAll('.toggle-task-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const taskType = button.dataset.taskType;
        const newState = !button.classList.contains('btn-turn-on'); // инвертируем состояние

        try {
            const response = await fetch("/ajax/set/turn", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    field: taskType,
                    value: newState
                })
            });

            if (response.ok) {
                // Обновляем визуально кнопку
                button.classList.toggle("btn-turn-on", newState);
                button.classList.toggle("btn-turn-off", !newState);

                const icon = button.querySelector("i");
                if (newState) {
                    icon.classList.remove("bi-x-lg");
                    icon.classList.add("bi-check-lg");
                } else {
                    icon.classList.remove("bi-check-lg");
                    icon.classList.add("bi-x-lg");
                }

                // Обновляем tooltip
                button.title = newState ? "Включено" : "Выключено";
            } else {
                const data = await response.json();
                console.error("Ошибка обновления:", data.message || response.statusText);
            }
        } catch (err) {
            console.error("Ошибка AJAX:", err);
        }
    });
});
</script>
{% endblock %}